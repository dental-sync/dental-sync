{
  "name": "My workflow",
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "claude-3-7-sonnet-20250219",
          "mode": "list",
          "cachedResultName": "Claude Sonnet 3.7"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.3,
      "position": [
        340,
        140
      ],
      "id": "b6b0c445-d97d-486e-94a0-0e62da882ec9",
      "name": "Anthropic Chat Model2",
      "credentials": {
        "anthropicApi": {
          "id": "JWxhaUWoUu4m768y",
          "name": "Anthropic account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n    'cliente' as tipo,\n    id,\n    nome\nFROM paciente \nWHERE is_active = 1\n\nUNION ALL\n\nSELECT \n    'dentista' as tipo,\n    id,\n    nome  \nFROM dentista\nWHERE is_active = 1\n\nUNION ALL\n\nSELECT \n    'protetico' as tipo,\n    id,\n    nome\nFROM protetico\nWHERE is_active = 1\n\nUNION ALL\n\nSELECT \n    'servico' as tipo,\n    id,\n    nome\nFROM servicos\nWHERE is_active = 1\n\nORDER BY tipo, nome;",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        -580,
        -80
      ],
      "id": "ad23c8af-385e-49ab-b637-ff14d086fd78",
      "name": "MySQL",
      "alwaysOutputData": false,
      "credentials": {
        "mySql": {
          "id": "4jMQlb3qor12npee",
          "name": "MySQL account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=\"SISTEMA DE EXTRA√á√ÉO DE IDs PARA PEDIDOS ODONTOL√ìGICOS - VALIDA√á√ÉO EXTREMA ANTI-INVEN√á√ÉO\n\n‚ö†Ô∏è ATEN√á√ÉO: VOC√ä EST√Å RETORNANDO DADOS INCORRETOS! SIGA ESTAS INSTRU√á√ïES RIGOROSAMENTE! ‚ö†Ô∏è\n\n‚ö†Ô∏è REGRA CR√çTICA: RETORNE APENAS JSON PURO - NENHUM TEXTO ADICIONAL ‚ö†Ô∏è\n\n‚ö†Ô∏è PROBLEMA IDENTIFICADO: VOC√ä EST√Å RETORNANDO SERVI√áOS N√ÉO MENCIONADOS NA MENSAGEM ‚ö†Ô∏è\n\nPROCESSO OBRIGAT√ìRIO DE VERIFICA√á√ÉO EM 9 ETAPAS:\n\nETAPA 1: LEIA A MENSAGEM DO USU√ÅRIO PALAVRA POR PALAVRA\n- Identifique APENAS palavras-chave que est√£o fisicamente escritas\n- N√£o interprete contexto\n- N√£o assuma nada\n\nETAPA 2: IDENTIFIQUE TIPOS APENAS COM PALAVRAS-CHAVE PRESENTES:\n‚Ä¢ CLIENTE: \"cliente √©\", \"paciente\", \"para o\", \"para a\", \"Sr.\", \"Sra.\"\n‚Ä¢ DENTISTA: \"dentista\", \"doutor\", \"dr\", \"dra\", \"cirurgi√£o\", \"pedido por\", \"solicitado por\", \"encomendado por\"\n‚Ä¢ PROTETICO: \"prot√©tico\", \"t√©cnico\", \"laboratorista\", \"feito por\", \"executado por\", \"realizado por\", \"respons√°vel por\"  \n‚Ä¢ SERVICO: \"servi√ßo\", \"procedimento\", \"fazer\", \"produzir\", \"executar\", \"realizar\", \"colocar\", \"confeccionar\"\n‚Ä¢ DENTES: n√∫meros espec√≠ficos (11, 12, 13, 14, 15, 16, 17, 18, 21, 22, 23, 24, 25, 26, 27, 28, 31, 32, 33, 34, 35, 36, 37, 38, 41, 42, 43, 44, 45, 46, 47, 48), \"dente\", \"elemento\", \"no dente\", \"nos dentes\"\n‚Ä¢ PRIORIDADE: \"alta\", \"m√©dia\", \"baixa\" - APENAS ESSAS TR√äS OP√á√ïES EXISTEM NO SISTEMA\n‚Ä¢ QUANTIDADE: n√∫meros espec√≠ficos como \"2 pe√ßas\", \"3 unidades\", \"1 coroa\", \"duas\", \"tr√™s\", \"uma\", \"um\"\n‚Ä¢ DATA: datas espec√≠ficas como \"hoje\", \"amanh√£\", \"15/01\", \"janeiro\", \"dia 20\", formato DD/MM/YYYY, DD/MM, DD-MM-YYYY\n\nETAPA 3: EXTRAIA APENAS NOMES EXPL√çCITOS\n- Extraia APENAS nomes que aparecem IMEDIATAMENTE ap√≥s ou antes das palavras-chave\n- Se n√£o h√° nome espec√≠fico ap√≥s a palavra-chave, N√ÉO extraia nada\n\nETAPA 4: PARA CADA SERVI√áO - VERIFICA√á√ÉO TRIPLA OBRIGAT√ìRIA:\nüîç PERGUNTA 1: O nome do servi√ßo est√° LITERALMENTE escrito na mensagem?\n   - Se N√ÉO ‚Üí array vazio\n   - Se SIM ‚Üí continue para pergunta 2\n\nüîç PERGUNTA 2: O nome escrito na mensagem tem correspond√™ncia EXATA no banco?\n   - Normalize: min√∫sculas, sem acentos, sem caracteres especiais\n   - Compare com nomes do banco normalizados da mesma forma\n   - Se N√ÉO h√° correspond√™ncia exata ‚Üí array vazio\n   - Se SIM ‚Üí continue para pergunta 3\n\nüîç PERGUNTA 3: O ID encontrado existe FISICAMENTE no banco fornecido?\n   - Procure literalmente pelo ID nos dados\n   - Verifique se tem tipo=\"servico\"\n   - Se N√ÉO ‚Üí array vazio\n   - Se SIM ‚Üí pode incluir no array\n\nETAPA 4.1: PARA DENTES - VERIFICA√á√ÉO OBRIGAT√ìRIA:\nü¶∑ PERGUNTA 1: H√° n√∫meros espec√≠ficos de dentes mencionados na mensagem?\n   - Procure por n√∫meros de 11-18, 21-28, 31-38, 41-48\n   - Procure por palavras como \"dente 18\", \"elemento 17\", \"no dente 21\"\n   - Se N√ÉO h√° n√∫meros espec√≠ficos ‚Üí array vazio\n   - Se SIM ‚Üí adicione apenas os n√∫meros explicitamente mencionados\n\nü¶∑ PERGUNTA 2: O dente mencionado existe no padr√£o odontol√≥gico?\n   - Verifique se est√° entre: 11,12,13,14,15,16,17,18,21,22,23,24,25,26,27,28,31,32,33,34,35,36,37,38,41,42,43,44,45,46,47,48\n   - Se N√ÉO ‚Üí array vazio\n   - Se SIM ‚Üí pode incluir\n\nETAPA 4.2: PARA PRIORIDADE - VERIFICA√á√ÉO OBRIGAT√ìRIA:\nüéØ PERGUNTA 1: H√° men√ß√£o expl√≠cita de prioridade na mensagem?\n   - Procure APENAS por: \"alta\", \"m√©dia\", \"baixa\"\n   - Se N√ÉO h√° men√ß√£o de uma dessas tr√™s palavras exatas ‚Üí null\n   - Se SIM ‚Üí retornar exatamente: \"alta\", \"media\", \"baixa\"\n\nüéØ MAPEAMENTO DE PRIORIDADE (APENAS ESSAS TR√äS OP√á√ïES):\n   - \"alta\" ‚Üí \"alta\"\n   - \"m√©dia\" ‚Üí \"media\"  \n   - \"baixa\" ‚Üí \"baixa\"\n   - Qualquer outra palavra ou nenhuma men√ß√£o ‚Üí null\n\nETAPA 4.3: PARA QUANTIDADE - VERIFICA√á√ÉO OBRIGAT√ìRIA:\nüìä PERGUNTA 1: H√° men√ß√£o de quantidade espec√≠fica para cada servi√ßo?\n   - Procure por n√∫meros + servi√ßos: \"2 coroas\", \"3 reparos\", \"uma placa\"\n   - Procure por palavras: \"um\", \"uma\", \"dois\", \"duas\", \"tr√™s\", \"quatro\", etc.\n   - Se N√ÉO h√° quantidade espec√≠fica ‚Üí quantidade: 1 (padr√£o)\n   - Se SIM ‚Üí extrair n√∫mero exato mencionado\n\nüìä MAPEAMENTO DE QUANTIDADE:\n   - \"um\", \"uma\" ‚Üí 1\n   - \"dois\", \"duas\" ‚Üí 2\n   - \"tr√™s\" ‚Üí 3\n   - N√∫meros escritos (1, 2, 3, etc.) ‚Üí usar o n√∫mero\n   - Nenhuma men√ß√£o ‚Üí 1 (padr√£o)\n\nETAPA 4.4: PARA DATA - VERIFICA√á√ÉO OBRIGAT√ìRIA:\nüìÖ PERGUNTA 1: H√° men√ß√£o de data espec√≠fica na mensagem?\n   - Procure por: \"hoje\", \"amanh√£\", \"15/01\", \"dia 20\", \"janeiro\", \"fevereiro\", etc.\n   - Procure por formatos: DD/MM/YYYY, DD/MM, DD-MM-YYYY\n   - Se N√ÉO h√° data espec√≠fica ‚Üí null\n   - Se SIM ‚Üí converter para formato brasileiro DD/MM/YYYY\n\nüìÖ MAPEAMENTO DE DATA:\n   - \"hoje\" ‚Üí data atual em formato DD/MM/YYYY\n   - \"amanh√£\" ‚Üí data atual + 1 dia em formato DD/MM/YYYY\n   - \"DD/MM\" ‚Üí assumir ano atual e completar DD/MM/YYYY\n   - \"DD/MM/YYYY\" ‚Üí manter formato brasileiro\n   - \"DD-MM-YYYY\" ‚Üí converter para DD/MM/YYYY\n   - Nomes de meses ‚Üí usar com dia se especificado em formato DD/MM/YYYY\n   - Nenhuma men√ß√£o ‚Üí null\n\nETAPA 5: AUTOVALIDA√á√ÉO OBRIGAT√ìRIA\nAntes de retornar, responda internamente estas perguntas:\n\nPARA CLIENTE_ID:\n- A palavra \"cliente\", \"paciente\", \"Sr.\" ou \"Sra.\" aparece na mensagem? SE N√ÉO ‚Üí null\n- H√° um nome espec√≠fico mencionado ap√≥s essas palavras? SE N√ÉO ‚Üí null\n- Esse nome existe no banco como tipo \"cliente\"? SE N√ÉO ‚Üí null\n\nPARA DENTISTA_ID:\n- A palavra \"dentista\", \"doutor\", \"dr\", \"dra\" ou similar aparece na mensagem? SE N√ÉO ‚Üí null\n- H√° um nome espec√≠fico mencionado? SE N√ÉO ‚Üí null\n- Esse nome existe no banco como tipo \"dentista\"? SE N√ÉO ‚Üí null\n\nPARA PROTETICO_ID:\n- A palavra \"prot√©tico\", \"t√©cnico\" ou similar aparece na mensagem? SE N√ÉO ‚Üí null\n- H√° um nome espec√≠fico mencionado? SE N√ÉO ‚Üí null\n- Esse nome existe no banco como tipo \"protetico\"? SE N√ÉO ‚Üí null\n\nPARA SERVICOS:\n- H√° nomes espec√≠ficos de servi√ßos mencionados na mensagem? SE N√ÉO ‚Üí []\n- Cada nome mencionado existe exatamente no banco? SE N√ÉO ‚Üí []\n- N√£o estou assumindo servi√ßos baseado em contexto geral? SE ESTOU ‚Üí []\n- Para cada servi√ßo, h√° quantidade espec√≠fica mencionada? SE N√ÉO ‚Üí quantidade: 1\n\nPARA DENTES:\n- H√° n√∫meros espec√≠ficos de dentes mencionados? SE N√ÉO ‚Üí []\n- Cada n√∫mero est√° no padr√£o odontol√≥gico v√°lido? SE N√ÉO ‚Üí []\n- N√£o estou assumindo dentes baseado em contexto? SE ESTOU ‚Üí []\n\nPARA PRIORIDADE:\n- A palavra \"alta\", \"m√©dia\" ou \"baixa\" aparece EXATAMENTE na mensagem? SE N√ÉO ‚Üí null\n- N√£o estou interpretando outras palavras como prioridade? SE ESTOU ‚Üí null\n\nPARA DATA:\n- H√° data espec√≠fica mencionada na mensagem? SE N√ÉO ‚Üí null\n- A data est√° em formato reconhec√≠vel? SE N√ÉO ‚Üí null\n- N√£o estou assumindo data n√£o mencionada? SE ESTOU ‚Üí null\n\nETAPA 6: CASOS DE RETORNO OBRIGAT√ìRIO NULL/VAZIO:\n‚Ä¢ \"fazer um procedimento\" SEM especificar qual ‚Üí servicos: []\n‚Ä¢ \"atendimento\" SEM especificar tipo ‚Üí servicos: []\n‚Ä¢ \"tratamento\" SEM especificar qual ‚Üí servicos: []\n‚Ä¢ \"consulta\" SEM especificar tipo ‚Üí servicos: []\n‚Ä¢ Qualquer men√ß√£o gen√©rica SEM nome espec√≠fico ‚Üí servicos: []\n‚Ä¢ \"nos dentes\" SEM n√∫meros espec√≠ficos ‚Üí dentes: []\n‚Ä¢ \"alguns dentes\" SEM n√∫meros espec√≠ficos ‚Üí dentes: []\n‚Ä¢ Qualquer palavra que N√ÉO seja \"alta\", \"m√©dia\" ou \"baixa\" ‚Üí prioridade: null\n‚Ä¢ Nenhuma data espec√≠fica mencionada ‚Üí data: null\n\nETAPA 7: VALIDA√á√ÉO FINAL EXTREMA\nüö® CHECKPOINT OBRIGAT√ìRIO ANTES DE RETORNAR:\n‚ñ° Reli a mensagem palavra por palavra?\n‚ñ° Cada item retornado est√° LITERALMENTE na mensagem?\n‚ñ° N√£o estou inferindo nada que n√£o foi escrito?\n‚ñ° Cada ID existe fisicamente no banco?\n‚ñ° O array de servi√ßos cont√©m APENAS servi√ßos explicitamente mencionados?\n‚ñ° O array de dentes cont√©m APENAS n√∫meros explicitamente mencionados?\n‚ñ° A prioridade √© EXATAMENTE \"alta\", \"media\" ou \"baixa\" ou null?\n‚ñ° As quantidades correspondem ao que foi mencionado?\n‚ñ° A data est√° no formato brasileiro DD/MM/YYYY ou null?\n‚ñ° Se alguma resposta for N√ÉO, corrigi para null/vazio?\n\nT√âCNICA ANTI-ALUCINA√á√ÉO:\nüß† PENSE ANTES DE RESPONDER:\n\"O que EXATAMENTE est√° escrito na mensagem?\"\n\"Que NOMES ESPEC√çFICOS foram mencionados?\"\n\"Que N√öMEROS DE DENTES foram explicitamente citados?\"\n\"A palavra 'alta', 'm√©dia' ou 'baixa' aparece na mensagem?\"\n\"Que QUANTIDADES foram mencionadas para cada servi√ßo?\"\n\"Que DATA espec√≠fica foi mencionada?\"\n\"Estou assumindo algo que n√£o foi dito?\"\n\"Cada ID que vou retornar foi EXPLICITAMENTE mencionado?\"\n\nEXEMPLOS DE VALIDA√á√ÉO CORRETA:\n\n‚ùå ERRADO:\nMensagem: \"fazer um procedimento para Jo√£o\"\nResposta errada: {\"servicos\": [{\"id\": 9, \"quantidade\": 1}]} ‚Üê ID 9 N√ÉO foi mencionado!\n\n‚úÖ CORRETO:\nMensagem: \"fazer um procedimento para Jo√£o\"  \nResposta correta: {\"cliente_id\": X, \"servicos\": [], \"dentes\": [], \"prioridade\": null, \"data\": null} ‚Üê Arrays vazios porque nenhum servi√ßo espec√≠fico foi mencionado\n\n‚ùå ERRADO:\nMensagem: \"2 reparos frontais no dente 18 hoje\"\nResposta errada: {\"servicos\": [{\"id\": 2, \"quantidade\": 2}], \"dentes\": [18, 17]} ‚Üê Dente 17 N√ÉO foi mencionado!\n\n‚úÖ CORRETO:\nMensagem: \"2 reparos frontais no dente 18 e 17 hoje\"\nResposta correta: {\"servicos\": [{\"id\": 2, \"quantidade\": 2}], \"dentes\": [18, 17], \"data\": \"15/01/2024\"} ‚Üê Quantidade e dentes explicitamente mencionados\n\nREGRAS ABSOLUTAS FINAIS:\n‚úì Seja extremamente literal\n‚úì Na menor d√∫vida, retorne null/vazio\n‚úì Prefira false negatives a false positives\n‚úì Releia a mensagem antes de responder\n‚úì Valide cada ID no banco fisicamente\n‚úì Dentes: apenas n√∫meros explicitamente mencionados\n‚úì Prioridade: APENAS \"alta\", \"media\", \"baixa\" - nenhuma outra palavra\n‚úì Quantidade: apenas se explicitamente mencionada, sen√£o padr√£o 1\n‚úì Data: apenas se explicitamente mencionada em formato DD/MM/YYYY, sen√£o null\n\n‚úó NUNCA assuma servi√ßos n√£o mencionados\n‚úó NUNCA interprete contexto para criar dados\n‚úó NUNCA retorne IDs que n√£o foram explicitamente referenciados\n‚úó NUNCA complete informa√ß√µes faltantes\n‚úó NUNCA assuma dentes n√£o mencionados\n‚úó NUNCA interprete outras palavras como prioridade al√©m de \"alta\", \"m√©dia\", \"baixa\"\n‚úó NUNCA assuma quantidades n√£o mencionadas (use padr√£o 1)\n‚úó NUNCA assuma datas n√£o mencionadas\n\nFORMATO DE SA√çDA (APENAS ESTE JSON - NADA MAIS):\n{\n  \"cliente_id\": null_apenas_se_explicitamente_mencionado,\n  \"dentista_id\": null_apenas_se_explicitamente_mencionado,\n  \"protetico_id\": null_apenas_se_explicitamente_mencionado,\n  \"servicos\": [{\"id\": servico_id, \"quantidade\": numero_ou_1_padrao}],\n  \"dentes\": [array_vazio_se_nao_ha_numeros_especificos_mencionados],\n  \"prioridade\": null_ou_apenas_alta_media_baixa,\n  \"data\": null_ou_DD/MM/YYYY\n}\n\nDADOS DO BANCO:\n{{ $json.dados }}\n\nMENSAGEM DO USU√ÅRIO:\n{{ $json.message }}\n\nDATA ATUAL:\n{{ $json.data_hoje }}\n\n\nüö® LEMBRE-SE: √â MELHOR RETORNAR VAZIO DO QUE INVENTAR! SEJA ULTRA CONSERVADOR! üö®\n\n‚ö†Ô∏è ANTES DE RETORNAR: PARE, RESPIRE, RELEIA A MENSAGEM, E CONFIRME QUE CADA ITEM FOI EXPLICITAMENTE MENCIONADO! ‚ö†Ô∏è\"",
        "options": {
          "maxIterations": 1
        }
      },
      "id": "5fe65349-6e0b-43ff-858b-cad3ec735745",
      "name": "Extrator1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        320,
        -20
      ]
    },
    {
      "parameters": {
        "path": "dental-sync",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -780,
        20
      ],
      "id": "d05af5f9-ab13-4995-bdb1-a6482688b68d",
      "name": "Webhook1",
      "webhookId": "14e8bc9a-3947-4e19-8bf9-904989cb6179"
    },
    {
      "parameters": {
        "jsCode": "const dados = $input.all().map(item => item.json);\n\nreturn [{\n  json: {\n    dados: JSON.stringify(dados)\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -380,
        -80
      ],
      "id": "e8cc76d5-a711-4338-8d79-cbd99aa0a9b6",
      "name": "Code2"
    },
    {
      "parameters": {
        "jsCode": "const message = $input.first().json.query.message\n\nreturn [{\n  json: {\n    message: JSON.stringify(message)\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -380,
        60
      ],
      "id": "b68509fc-972d-46d7-83a6-95fcb1c537d1",
      "name": "Code3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        700,
        -20
      ],
      "id": "811e5caa-a209-4ae9-9652-32d39e54b82a",
      "name": "Respond to Webhook2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -160,
        -20
      ],
      "id": "9b03ddfc-688c-4049-8b18-600a7e1cdc04",
      "name": "Merge1"
    },
    {
      "parameters": {
        "jsCode": "const input1 = $input.all()[0].json;\nconst input2 = $input.all()[1].json;\n\nconst hoje = new Date().toLocaleDateString('pt-BR'); // ex: \"19/06/2025\"\n\nreturn [{\n  json: {\n    dados: input1.dados,\n    message: input2.message,\n    data_hoje: hoje\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        -20
      ],
      "id": "5190ccfc-28b1-483d-82e4-cd5d377679f9",
      "name": "Code4"
    }
  ],
  "pinData": {},
  "connections": {
    "Anthropic Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Extrator1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "MySQL": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrator1": {
      "main": [
        [
          {
            "node": "Respond to Webhook2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook1": {
      "main": [
        [
          {
            "node": "MySQL",
            "type": "main",
            "index": 0
          },
          {
            "node": "Code3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code3": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Code4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code4": {
      "main": [
        [
          {
            "node": "Extrator1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "2d5d6e59-176f-4c7a-a147-a587f139b75a",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f10c7f9b1aa6881d4216d1b3ca3a4a6aec26ab3672f3944a24fa37c262b4ddf6"
  },
  "id": "LTzHlXLKQQeoyumC",
  "tags": []
}